<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>{{ track.audio_file.name|default:'Track' }} — Detail</title>

  <!-- CLEAN + VALID CSS -->
  <style>
    body {
      background: radial-gradient(circle at top, #0a0f1f, #000);
      color: #f1f1f1;
      font-family: Inter, sans-serif;
    }

   

    .music-card {
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 0 18px rgba(0,0,0,0.3);
    }

    canvas { 
      width: 100% !important; 
      height: 220px !important; 
      display: block; 
      border-radius: 8px; 
    }

    pre { 
      white-space: pre-wrap; 
      word-break: break-word; 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 
                   "Segoe UI", Roboto, "Helvetica Neue", Arial; 
    }

    .metric-bar { 
      height: 10px; 
      border-radius: 999px; 
      background: rgba(255,255,255,0.08); 
      overflow: hidden; 
    }

    .metric-fill { 
      height: 100%; 
      border-radius: 999px; 
      transition: width .4s ease-in-out; 
    }

    .small-muted { 
      color: #9ca3af; 
      font-size: 0.875rem; 
    }

    .badge { 
      padding: 4px 8px; 
      border-radius: 999px; 
      font-weight: 600; 
      font-size: 0.85rem; 
    }
  </style>

</head>

<body>
<div class="container mx-auto max-w-4xl py-10">

</div>
</head>

<body>
<div class="container mx-auto max-w-4xl py-10">

  <h1 class="text-4xl font-bold text-cyan-300 mb-8 tracking-wide">Track Detail</h1>

  <!-- TRACK INFO + MASTER BUTTON -->
  <div class="music-card">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold text-blue-300">{{ track.audio_file.name|default:"Track" }}</h2>
        <p class="small-muted mt-1">Status: <strong class="text-white">{{ track.status|default:"unknown" }}</strong> · Score: <strong>{{ score|default:0|floatformat:2 }}</strong></p>
      </div>

      {% if not track.master_file %}
        {% if free_limit_reached %}
          <button disabled class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow-md opacity-60 cursor-not-allowed">✨ Master Track (Upgrade)</button>
        {% else %}
          <form method="post" action="{% url 'master_track' track.id %}">
            {% csrf_token %}
            <button class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg shadow-md transition">✨ Master Track</button>
          </form>
        {% endif %}
      {% else %}
        <div class="flex items-center gap-3">
          <a href="{{ track.master_file.url }}" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg shadow-md transition">⬇ Download Mastered</a>
          <span class="badge bg-purple-700/40 text-purple-200">Mastered</span>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- AUDIO ANALYSIS (top-level audio feedback) -->
  <div class="music-card">
    <h2 class="text-xl font-semibold text-blue-300 mb-2">Audio Analysis</h2>
    <div class="text-gray-200 leading-relaxed">
      {{ ai_feedback|default:"Analysis pending..."|safe }}
    </div>
  </div>

  <!-- AUDIO PLAYERS -->
  {% if track.audio_file %}
  <div class="music-card">
    <h2 class="text-xl font-semibold text-blue-300 mb-3">Original</h2>

    <div class="flex items-center gap-4 mb-4">
      <button id="playOriginalBtn" class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 flex items-center justify-center text-xl transition">▶</button>

      <div class="flex-1">
        <div id="origProgressContainer" class="w-full h-2 bg-gray-700 rounded-full cursor-pointer relative overflow-hidden">
          <div id="origProgressBar" class="absolute top-0 left-0 h-full bg-blue-400 metric-fill" style="width:0%"></div>
        </div>
        <div class="flex justify-between text-sm text-gray-400 mt-1">
          <span id="origCurrentTime">0:00</span>
          <span id="origDuration">0:00</span>
        </div>
      </div>
    </div>

    <audio id="audioOriginal" preload="metadata" crossorigin="anonymous">
      <source src="{{ track.audio_file.url }}" type="audio/mpeg">
    </audio>
  </div>
  {% endif %}

  {% if track.master_file %}
  <div class="music-card">
    <h2 class="text-xl font-semibold text-purple-300 mb-3">Mastered</h2>

    <div class="flex items-center gap-4 mb-4">
      <button id="playMasterBtn" class="w-12 h-12 rounded-full bg-purple-600 hover:bg-purple-700 flex items-center justify-center text-xl transition">▶</button>

      <div class="flex-1">
        <div id="masterProgressContainer" class="w-full h-2 bg-gray-700 rounded-full cursor-pointer relative overflow-hidden">
          <div id="masterProgressBar" class="absolute top-0 left-0 h-full bg-purple-400 metric-fill" style="width:0%"></div>
        </div>
        <div class="flex justify-between text-sm text-gray-400 mt-1">
          <span id="masterCurrentTime">0:00</span>
          <span id="masterDuration">0:00</span>
        </div>
      </div>
    </div>

    <audio id="audioMaster" preload="metadata" crossorigin="anonymous">
      <source src="{{ track.master_file.url }}" type="audio/mpeg">
    </audio>
  </div>
  {% endif %}

  <!-- REALTIME WAVEFORM (shared canvas) -->
  {% if track.audio_file %}
  <div class="music-card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold text-blue-300">Realtime Waveform</h2>
      <div class="small-muted" id="waveformLabel">Now Visualizing: ORIGINAL</div>
    </div>
    <canvas id="realtimeWaveform" aria-label="Realtime waveform visualization"></canvas>
  </div>
  {% endif %}

  <!-- RMS + CENTROID CHARTS -->
  <div class="grid md:grid-cols-2 gap-4">
    <div class="music-card">
      <h3 class="text-lg font-semibold text-blue-300 mb-2">RMS Over Time</h3>
      <canvas id="rmsChart"></canvas>
    </div>

    <div class="music-card">
      <h3 class="text-lg font-semibold text-blue-300 mb-2">Spectral Centroid</h3>
      <canvas id="centroidChart"></canvas>
    </div>
  </div>

  <!-- FULL PAGE LYRICS SECTION -->

  <!-- 1) FULL TRANSCRIPTION -->
  <div class="music-card">
    <h2 class="text-xl font-semibold text-pink-300 mb-2">Full Transcription</h2>

    {% if track.analysis and track.analysis.lyrics_raw %}
      <pre class="text-gray-100 p-3 bg-black/30 rounded">{{ track.analysis.lyrics_raw }}</pre>
    {% else %}
      <p class="text-gray-400">No transcription available yet.</p>
    {% endif %}
  </div>

  <!-- 2) CLEANED LYRICS -->
  <div class="music-card">
    <h2 class="text-xl font-semibold text-pink-300 mb-2">Cleaned / Formatted Lyrics</h2>

    {% if track.analysis and track.analysis.lyrics_clean %}
      <pre class="text-gray-100 p-3 bg-black/30 rounded">{{ track.analysis.lyrics_clean }}</pre>
    {% else %}
      <p class="text-gray-400">No cleaned lyrics available yet.</p>
    {% endif %}

    {% if track.analysis and track.analysis.lyrics_feedback %}
      <div class="mt-3 p-3 bg-gray-900 rounded">
        <h3 class="text-sm text-gray-300 mb-1">Lyrics — quick notes</h3>
        <p class="text-sm text-gray-400">{{ track.analysis.lyrics_feedback|linebreaksbr }}</p>
      </div>
    {% endif %}
  </div>

  <!-- 3) AI LYRICAL ANALYSIS -->
  <div class="music-card">
    <h2 class="text-xl font-semibold text-rose-300 mb-2">AI Lyrical Analysis</h2>

    {% if lyrics_ai_review %}
      <div class="prose max-w-none text-gray-200">
        {{ lyrics_ai_review|safe }}
      </div>
    {% elif track.analysis and track.analysis.lyrics_ai_review %}
      <div class="prose max-w-none text-gray-200">
        {{ track.analysis.lyrics_ai_review|safe }}
      </div>
    {% else %}
      <p class="text-gray-400">No AI lyric analysis available yet.</p>
    {% endif %}
  </div>

  <!-- 4) LYRICAL METRICS -->
  <div class="music-card">
    <h2 class="text-xl font-semibold text-rose-300 mb-2">Lyrical Quality Metrics</h2>

    <div class="grid gap-4">
      <!-- Lyrics Quality (expects lyrics_quality_pct in context, 0-100) -->
      <div>
        <div class="flex justify-between items-baseline">
          <div class="text-gray-200">Lyrics Quality</div>
          <div class="text-sm text-gray-400">{{ lyrics_quality_pct|default:0|floatformat:0 }}%</div>
        </div>
        <div class="metric-bar mt-1">
          <div class="metric-fill bg-gradient-to-r from-sky-300 to-cyan-500"></div>
        </div>
        <p class="small-muted mt-1">Higher is better (0–100).</p>
      </div>

      <!-- Rhyme Density -->
      <div>
        <div class="flex justify-between items-baseline">
          <div class="text-gray-200">Rhyme Density</div>
          <div class="text-sm text-gray-400">{{ rhyme_density_pct|default:0|floatformat:0 }}%</div>
        </div>
        <div class="metric-bar mt-1">
          <div class="metric-fill bg-gradient-to-r from-yellow-300 to-pink-500"></div>
        </div>
      </div>

      <!-- Profanity -->
      <div>
        <div class="flex justify-between items-baseline">
          <div class="text-gray-200">Profanity</div>
          <div class="text-sm text-gray-400">{{ profanity_score_pct|default:0|floatformat:0 }}%</div>
        </div>
        <div class="metric-bar mt-1">
          <div class="metric-fill bg-red-500"></div>
        </div>
        <p class="small-muted mt-1">Higher → more profanity in lyrics.</p>
      </div>

      {% if track.analysis and track.analysis.sentiment_hint %}
      <div>
        <div class="text-gray-200">Sentiment</div>
        <div class="text-sm text-gray-400 mt-1">{{ track.analysis.sentiment_hint }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Footer / small help text -->
  <p class="text-center small-muted mt-6">Tip: Transcription & analysis run inside the worker. If you just uploaded, refresh after the worker finishes to see lyrics & metrics. Percent bars use context vars: <code>lyrics_quality_pct</code>, <code>rhyme_density_pct</code>, <code>profanity_score_pct</code> (0–100).</p>
</div>

<!-- JSON DATA for charts (safe embedding) -->
<script id="waveform-data" type="application/json">{{ waveform|default:"[]"|safe }}</script>
<script id="rms-data" type="application/json">{{ rms|default:"[]"|safe }}</script>
<script id="centroid-data" type="application/json">{{ spectral_centroid|default:"[]"|safe }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* --------------------------
     Helper: format time
     -------------------------- */
  function fmt(t) {
    if (!t || isNaN(t)) return "0:00";
    const m = Math.floor(t/60); const s = Math.floor(t%60).toString().padStart(2,"0");
    return `${m}:${s}`;
  }

  /* --------------------------
     Charts: RMS + Centroid
     -------------------------- */
  function createChart(id, data, label, borderColor) {
    const el = document.getElementById(id);
    if (!el) return;
    new Chart(el.getContext("2d"), {
      type: "line",
      data: {
        labels: data.map((_,i)=>i),
        datasets: [{ label, data, borderColor, borderWidth: 1, fill: false, pointRadius: 0 }]
      },
      options: { responsive: true, scales: { x: { display: false }, y: { beginAtZero: true } }, elements: { line: { tension: 0.3 } } }
    });
  }

  try {
    const rms = JSON.parse(document.getElementById("rms-data").textContent || "[]");
    const centroid = JSON.parse(document.getElementById("centroid-data").textContent || "[]");
    createChart("rmsChart", rms, "RMS", "rgba(34,197,94,0.9)");
    createChart("centroidChart", centroid, "Centroid", "rgba(249,115,22,0.9)");
  } catch(e){/* ignore parse errors */}

  /* --------------------------
     Players: Original + Master (controls)
     -------------------------- */
  const orig = document.getElementById("audioOriginal");
  const origBtn = document.getElementById("playOriginalBtn");
  const origBar = document.getElementById("origProgressBar");
  const origWrap = document.getElementById("origProgressContainer");
  const origCur = document.getElementById("origCurrentTime");
  const origDur = document.getElementById("origDuration");

  const master = document.getElementById("audioMaster");
  const masterBtn = document.getElementById("playMasterBtn");
  const mBar = document.getElementById("masterProgressBar");
  const mWrap = document.getElementById("masterProgressContainer");
  const mCur = document.getElementById("masterCurrentTime");
  const mDur = document.getElementById("masterDuration");

  if (orig && origBtn) {
    origBtn.addEventListener("click", () => {
      if (orig.paused) { orig.play(); origBtn.textContent="⏸"; }
      else { orig.pause(); origBtn.textContent="▶"; }
    });
    orig.onloadedmetadata = () => { origDur.textContent = fmt(orig.duration); };
    orig.ontimeupdate = () => { if (orig.duration) origBar.style.width = (orig.currentTime/orig.duration)*100 + "%"; origCur.textContent = fmt(orig.currentTime); };
    origWrap && origWrap.addEventListener("click", e => { const r = origWrap.getBoundingClientRect(); orig.currentTime = (e.clientX - r.left)/r.width*orig.duration; });
    orig.addEventListener("play", () => { if (master && !master.paused) master.pause(); });
  }

  if (master && masterBtn) {
    masterBtn.addEventListener("click", () => {
      if (master.paused) { master.play(); masterBtn.textContent="⏸"; }
      else { master.pause(); masterBtn.textContent="▶"; }
    });
    master.onloadedmetadata = () => { mDur.textContent = fmt(master.duration); };
    master.ontimeupdate = () => { if (master.duration) mBar.style.width = (master.currentTime/master.duration)*100 + "%"; mCur.textContent = fmt(master.currentTime); };
    mWrap && mWrap.addEventListener("click", e => { const r = mWrap.getBoundingClientRect(); master.currentTime = (e.clientX - r.left)/r.width*master.duration; });
    master.addEventListener("play", () => { if (orig && !orig.paused) orig.pause(); });
  }

  /* --------------------------
     Realtime Waveform (switches depending on which audio plays)
     -------------------------- */
  const canvas = document.getElementById("realtimeWaveform");
  if (canvas) {
    const ctx = canvas.getContext("2d");
    let audioCtx = null, analyser = null, sourceNode = null;
    const buf = new Uint8Array(2048);
    const label = document.getElementById("waveformLabel");
    let waveColor = "#00aaff";

    function attachTo(audioElem, color, labelText) {
      try {
        if (!audioElem) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        try { if (sourceNode) sourceNode.disconnect(); } catch(e){}

        sourceNode = audioCtx.createMediaElementSource(audioElem);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.8;
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);

        waveColor = color || "#00aaff";
        if (label) label.textContent = "Now Visualizing: " + (labelText || "ORIGINAL");
      } catch (err) {
        console.warn("attachTo waveform error:", err);
      }
    }

    function drawSmoothWave() {
      requestAnimationFrame(drawSmoothWave);
      if (!analyser) return;

      analyser.getByteTimeDomainData(buf);
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;

      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "#07101a";
      ctx.fillRect(0,0,w,h);

      ctx.lineWidth = 2;
      ctx.strokeStyle = waveColor;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.beginPath();

      const slice = w / (buf.length - 1);
      let x = 0;
      const points = [];
      for (let i=0;i<buf.length;i++){
        const y = (buf[i] / 128.0) * (h/2);
        points.push([x, y]);
        x += slice;
      }
      if (points.length < 2) return;

      ctx.moveTo(points[0][0], points[0][1]);
      for (let i = 1; i < points.length - 1; i++) {
        const xc = (points[i][0] + points[i+1][0]) / 2;
        const yc = (points[i][1] + points[i+1][1]) / 2;
        ctx.quadraticCurveTo(points[i][0], points[i][1], xc, yc);
      }
      const last = points[points.length - 1];
      ctx.lineTo(last[0], last[1]);
      ctx.stroke();
    }

    drawSmoothWave();

    if (orig) {
      orig.addEventListener("play", () => {
        attachTo(orig, "#00aaff", "ORIGINAL");
        if (audioCtx) audioCtx.resume();
      });
    }
    if (master) {
      master.addEventListener("play", () => {
        attachTo(master, "#bd4bff", "MASTERED");
        if (audioCtx) audioCtx.resume();
      });
    }
  }

});
</script>

</body>
</html>
